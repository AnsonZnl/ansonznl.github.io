"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[4884],{645:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-738970fc",path:"/articles/Node/Koa%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E4%B8%8E%E5%AE%9E%E7%8E%B0.html",title:"",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"å‰è¨€",slug:"å‰è¨€",children:[]},{level:2,title:"åˆ›å»ºä¸€ä¸ªç®€å•çš„KoaæœåŠ¡",slug:"åˆ›å»ºä¸€ä¸ªç®€å•çš„koaæœåŠ¡",children:[]},{level:2,title:"åˆ†ææºç å¹¶å®ç°è‡ªå·±çš„Koa",slug:"åˆ†ææºç å¹¶å®ç°è‡ªå·±çš„koa",children:[]},{level:2,title:"åˆ†æå¹¶å®ç°request.jsæ–‡ä»¶",slug:"åˆ†æå¹¶å®ç°request-jsæ–‡ä»¶",children:[]},{level:2,title:"å®ç°context.js",slug:"å®ç°context-js",children:[]},{level:2,title:"åˆ†æå¹¶å®ç°response.js",slug:"åˆ†æå¹¶å®ç°response-js",children:[]},{level:2,title:"å‰–æapplicationæºç å¹¶å®ç°å®ƒ",slug:"å‰–æapplicationæºç å¹¶å®ç°å®ƒ",children:[{level:3,title:"(1ï¼‰æ„é€ å‡½æ•°",slug:"_1-æ„é€ å‡½æ•°",children:[]}]},{level:2,title:"(2ï¼‰use()",slug:"_2-use",children:[]},{level:2,title:"(3ï¼‰listen()",slug:"_3-listen",children:[]},{level:2,title:"(4ï¼‰callback()",slug:"_4-callback",children:[]},{level:2,title:"(5ï¼‰compose()",slug:"_5-compose",children:[]},{level:2,title:"(6ï¼‰createContext()",slug:"_6-createcontext",children:[]},{level:2,title:"(7ï¼‰handleRequest()",slug:"_7-handlerequest",children:[]},{level:2,title:"(8ï¼‰respond()",slug:"_8-respond",children:[]}],filePathRelative:"articles/Node/Koaæºç è§£æä¸å®ç°.md",git:{}}},9120:(n,s,a)=>{a.r(s),a.d(s,{default:()=>y});var p=a(6252);const t=(0,p.Uk)("Koaæºç åœ°å€ï¼š"),e={href:"https://github.com/koajs/koa",target:"_blank",rel:"noopener noreferrer"},o=(0,p.Uk)("https://github.com/koajs/koa"),c={href:"https://koa.bootcss.com/",target:"_blank",rel:"noopener noreferrer"},l=(0,p.Uk)("Koa ä¸­æ–‡æ–‡æ¡£"),u={href:"https://github.com/koajs/koa/tree/master/docs",target:"_blank",rel:"noopener noreferrer"},r=(0,p.Uk)("Koa å®˜æ–¹è‹±æ–‡æ–‡æ¡£"),i=(0,p.uE)('<h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€" aria-hidden="true">#</a> å‰è¨€</h2><blockquote><p>Koaæ˜¯ç»§Expressåæ–°çš„Nodeæ¡†æ¶,ç”±ExpressåŸç­äººé©¬å¼€å‘,ç›¸æ¯”Expressæ›´åŠ ç®€æ´,æºç åªæœ‰2000å¤šè¡Œ,ç»“åˆæœ€æ–°çš„ECMAè¯­æ³•,è¿™ä½¿å¾—Koaæ›´å° æ›´å…·æœ‰è¡¨ç°åŠ› æ›´å¥å£®,å› ä¸ºæ¯ä¸ªä¸­é—´ä»¶çš„æ‰§è¡Œç»“æœéƒ½æ˜¯Promise,ç»“åˆAsync AwaitæŠ›å¼ƒå¤æ‚çš„ä¼ ç»Ÿå›è°ƒå½¢å¼ã€‚å¹¶ä¸”é”™è¯¯ç»“æœå¤„ç†èµ·æ¥ä¹Ÿæ›´åŠ æ–¹ä¾¿</p></blockquote><h2 id="åˆ›å»ºä¸€ä¸ªç®€å•çš„koaæœåŠ¡" tabindex="-1"><a class="header-anchor" href="#åˆ›å»ºä¸€ä¸ªç®€å•çš„koaæœåŠ¡" aria-hidden="true">#</a> åˆ›å»ºä¸€ä¸ªç®€å•çš„KoaæœåŠ¡</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// yarn add koa</span>\n<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>\n    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;Hello Koa&#39;</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\napp<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9001</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ğŸ‰æœåŠ¡å¼€å¯æˆåŠŸ,ç«¯å£å·ä¸º:9001&#39;</span><span class="token punctuation">)</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="åˆ†ææºç å¹¶å®ç°è‡ªå·±çš„koa" tabindex="-1"><a class="header-anchor" href="#åˆ†ææºç å¹¶å®ç°è‡ªå·±çš„koa" aria-hidden="true">#</a> åˆ†ææºç å¹¶å®ç°è‡ªå·±çš„Koa</h2><p><img src="https://s2.loli.net/2022/08/04/hrXDndIewobpcq2.png" alt="image.png"></p><ol><li>åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶å¤¹,ä½¿ç”¨npm initåˆå§‹é¡¹ç›®,package.jsonä¸­æ·»åŠ å¯åŠ¨å‘½ä»¤</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>\n  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;koa-server&quot;</span><span class="token punctuation">,</span>\n  <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>\n  <span class="token string">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>\n  <span class="token string">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>\n    <span class="token string">&quot;serve&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon server.js&quot;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol start="2"><li>æ–‡ä»¶å¤¹å†…æ–°å»ºkoaæ–‡ä»¶å¤¹å¹¶ä½¿ç”¨npm initåˆå§‹é¡¹ç›®,package.jsonä¸­æŒ‡å®šå…¥å£æ–‡ä»¶</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">{</span>\n  <span class="token string">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">,</span>\n  <span class="token string">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>\n  <span class="token string">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./lib/application.js&quot;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="3"><li>åœ¨koaæ–‡ä»¶ä¸­æ–°å»ºlibæ–‡ä»¶,åœ¨libæ–‡ä»¶ä¸­æ–°å»ºapplication.js context.js request.js response.js</li></ol><p><img src="https://s2.loli.net/2022/08/04/8B2zmxqHdPphuiE.png" alt="image.png"></p><h2 id="åˆ†æå¹¶å®ç°request-jsæ–‡ä»¶" tabindex="-1"><a class="header-anchor" href="#åˆ†æå¹¶å®ç°request-jsæ–‡ä»¶" aria-hidden="true">#</a> åˆ†æå¹¶å®ç°request.jsæ–‡ä»¶</h2><p>Koaæºç ä¸­request.jsæ–‡ä»¶åšäº†å¾ˆå¤šè¯·æ±‚ç›¸å…³çš„å‚æ•°å¤„ç†,é€šè¿‡get/setçš„è®¿é—®æ–¹å¼å¯¹å±æ€§è¿›è¡Œäº†åŒ…è£…,ä½¿ç”¨æˆ·è·å–å±æ€§æ›´åŠ æ–¹ä¾¿</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">//èŠ‚é€‰è‡ªï¼šhttps://github.com/koajs/koa/blob/master/lib/request.js</span>\n<span class="token doc-comment comment">/**\n* Get request URL.\n* <span class="token keyword">@return</span> <span class="token class-name"><span class="token punctuation">{</span>String<span class="token punctuation">}</span></span>\n* <span class="token keyword">@api</span> public\n*/</span>\n\n<span class="token keyword">get</span> <span class="token function">url</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>url\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n<span class="token doc-comment comment">/**\n* Set request URL.\n* <span class="token keyword">@api</span> public\n*/</span>\n\n<span class="token keyword">set</span> <span class="token function">url</span> <span class="token punctuation">(</span><span class="token parameter">val</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>url <span class="token operator">=</span> val\n<span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>å®ç°è‡ªå·±çš„request.js</li></ul><p>å†…éƒ¨çš„thisæŒ‡å‘ctx.request, æ‰€ä»¥ctx.requestä¸Šé¢å¿…é¡»æœ‰reqå¯¹è±¡,è¯¥å¯¹è±¡æŒ‡å‘åŸç”Ÿçš„requestå¯¹è±¡</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;url&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token keyword">get</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> query <span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> query<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">get</span> <span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname <span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">return</span> pathname<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="å®ç°context-js" tabindex="-1"><a class="header-anchor" href="#å®ç°context-js" aria-hidden="true">#</a> å®ç°context.js</h2><ul><li>contexté™¤äº†æä¾›è‡ªèº«æ–¹æ³•å’Œå±æ€§å¤–,è¿˜å¯¹å…¶ä»–å±æ€§è¿›è¡Œäº†å§”æ‰˜ <code>(å°†è¯·æ±‚ç›¸å…³çš„å±æ€§å§”æ‰˜åˆ°ctx.requsetä¸Š,å°†å“åº”ç›¸å…³çš„å±æ€§å’Œæ–¹æ³•ä»£ç†åˆ°ctx.response)</code>.</li><li>ç”¨æˆ·è®¿é—®ctx.bodyå…¶å®è®¿é—®çš„æ˜¯ctx.request.body<code>(åç»­åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡ctxæ—¶,ä¼šå°†requestæŒ‚è½½åˆ°ctxèº«ä¸Š)</code>.</li><li>delegateçš„åŸç†å°±æ˜¯ <code>__defineGetter__</code>,<code>__defineSetter__</code>å±æ€§,å¯ä»¥è®¿é—®å¯¹è±¡å±æ€§æ—¶,å°†å±æ€§å§”æ‰˜åˆ°å…¶ä»–å¯¹è±¡èº«ä¸Š</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> delegate <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;delegates&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">const</span> proto <span class="token operator">=</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ç»™contextè‡ªèº«æ·»åŠ å±æ€§å’Œæ–¹æ³•</span>\n  <span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// å½“ç›´æ¥è®¿é—®ctx.xxæ—¶ å§”æ‰˜åˆ°ctx.response.xxèº«ä¸Š</span>\n<span class="token function">delegate</span><span class="token punctuation">(</span>proto<span class="token punctuation">,</span> <span class="token string">&#39;response&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&#39;body&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&#39;status&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token comment">// å½“ç›´æ¥è®¿é—®ctx.xxæ—¶ å§”æ‰˜åˆ°ctx.request.xxèº«ä¸Š</span>\n<span class="token function">delegate</span><span class="token punctuation">(</span>proto<span class="token punctuation">,</span> <span class="token string">&#39;request&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&#39;query&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span>\n  <span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">&#39;url&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div>',21),k={href:"https://github.com/tj/node-delegates",target:"_blank",rel:"noopener noreferrer"},b=(0,p.Uk)("delegates"),d=(0,p.Uk)("æ˜¯ä¸€ä¸ªå¯¹è±¡è®¿é—®ä»£ç†çš„JSåº“ã€‚"),m={href:"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/__defineGetter__",target:"_blank",rel:"noopener noreferrer"},h=(0,p._)("strong",null,"defineGetter",-1),g=(0,p.Uk)("æ–¹æ³•å¯ä»¥å°†ä¸€ä¸ªå‡½æ•°ç»‘å®šåœ¨å½“å‰å¯¹è±¡çš„æŒ‡å®šå±æ€§ä¸Šï¼Œå½“é‚£ä¸ªå±æ€§è¢«è¯»å–æ—¶ï¼Œå°±è°ƒç”¨è¿™ä¸ªç»‘å®šçš„æ–¹æ³•ã€‚ï¼ˆå…¶å®å¯ä»¥ä½¿ç”¨Object.definePropertyã€å¯¹è±¡çš„get/setã€proxyä»£æ›¿ï¼‰"),f=(0,p.uE)('<ol><li>delegateå†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡__defineGetter__, __defineSetter__ä¸¤ç§æ–¹æ³•å®ç°çš„å±æ€§å§”æ‰˜</li><li>ä¸Šé¢çš„contextå®ç°æ–¹å¼, ä¹Ÿå¯ä»¥é€šè¿‡ä¸‹é¢__defineGetter__, __defineSetter__ç›´æ¥å®ç°</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> proto <span class="token operator">=</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>\n  <span class="token comment">// ç»™contextè‡ªèº«æ·»åŠ å±æ€§å’Œæ–¹æ³•</span>\n  <span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token keyword">function</span> <span class="token function">defineGetters</span><span class="token punctuation">(</span><span class="token parameter">taregt<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  proto<span class="token punctuation">.</span><span class="token function">__defineGetter__</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">[</span>taregt<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">defineGetters</span><span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;query&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">defineGetters</span><span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">defineGetters</span><span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">defineGetters</span><span class="token punctuation">(</span><span class="token string">&#39;response&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;body&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">defineGetters</span><span class="token punctuation">(</span><span class="token string">&#39;response&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;status&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n<span class="token keyword">function</span> <span class="token function">defineSetters</span><span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  proto<span class="token punctuation">.</span><span class="token function">__defineSetter__</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">[</span>target<span class="token punctuation">]</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n<span class="token function">defineSetters</span><span class="token punctuation">(</span><span class="token string">&#39;response&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;body&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token function">defineSetters</span><span class="token punctuation">(</span><span class="token string">&#39;response&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;status&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><h2 id="åˆ†æå¹¶å®ç°response-js" tabindex="-1"><a class="header-anchor" href="#åˆ†æå¹¶å®ç°response-js" aria-hidden="true">#</a> åˆ†æå¹¶å®ç°response.js</h2><p>å°†cxt.headerä»£ç†åˆ°this.res.headerä¸Šã€‚</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// https://github.com/koajs/koa/blob/master/lib/response.js</span>\n<span class="token doc-comment comment">/**\n   * Return response header.\n   *\n   * <span class="token keyword">@return</span> <span class="token class-name"><span class="token punctuation">{</span>Object<span class="token punctuation">}</span></span>\n   * <span class="token keyword">@api</span> public\n   */</span>\n\n  <span class="token keyword">get</span> <span class="token function">header</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">const</span> <span class="token punctuation">{</span> res <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span>\n    <span class="token keyword">return</span> <span class="token keyword">typeof</span> res<span class="token punctuation">.</span>getHeaders <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span>\n      <span class="token operator">?</span> res<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n      <span class="token operator">:</span> res<span class="token punctuation">.</span>_headers <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// Node &lt; 7.7</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token doc-comment comment">/**\n   * Return response header, alias as response.header\n   *\n   * <span class="token keyword">@return</span> <span class="token class-name"><span class="token punctuation">{</span>Object<span class="token punctuation">}</span></span>\n   * <span class="token keyword">@api</span> public\n   */</span>\n\n  <span class="token keyword">get</span> <span class="token function">headers</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>header\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n\n  <span class="token doc-comment comment">/**\n   * Get response status code.\n   *\n   * <span class="token keyword">@return</span> <span class="token class-name"><span class="token punctuation">{</span>Number<span class="token punctuation">}</span></span>\n   * <span class="token keyword">@api</span> public\n   */</span>\n\n  <span class="token keyword">get</span> <span class="token function">status</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">.</span>statusCode\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><ul><li>responseå†…éƒ¨é€šè¿‡get set æä¾›äº†å¾ˆå¤šå“åº”ç›¸å…³çš„å±æ€§å’Œæ–¹æ³•</li><li>ç®€å•å®ç°è‡ªå·±çš„response.js</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token punctuation">{</span>\n  _body<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>\n  <span class="token keyword">get</span> <span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_body<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">set</span> <span class="token function">body</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>_body <span class="token operator">=</span> value<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">get</span> <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">.</span>statusCode<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n  <span class="token keyword">set</span> <span class="token function">status</span><span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> code<span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">,</span>\n<span class="token punctuation">}</span><span class="token punctuation">;</span>\nmodule<span class="token punctuation">.</span>exports <span class="token operator">=</span> response<span class="token punctuation">;</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="å‰–æapplicationæºç å¹¶å®ç°å®ƒ" tabindex="-1"><a class="header-anchor" href="#å‰–æapplicationæºç å¹¶å®ç°å®ƒ" aria-hidden="true">#</a> å‰–æapplicationæºç å¹¶å®ç°å®ƒ</h2><h3 id="_1-æ„é€ å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#_1-æ„é€ å‡½æ•°" aria-hidden="true">#</a> (1ï¼‰æ„é€ å‡½æ•°</h3><ul><li>ç»§æ‰¿Eventså‡½æ•°,å¯ä»¥ç›´æ¥è®¢é˜…æˆ–å‘å¸ƒäº‹ä»¶</li><li>é€šè¿‡Object.create()åˆ†åˆ«åˆ›å»ºcontext,request,responseå¯¹è±¡,ç›®çš„æ˜¯ä¸ºäº†åŸºäºåŸå‹é“¾åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡,é¿å…å…¨å±€ä¸­å¤šä¸ªç¨‹åºé€ æˆå¯¹è±¡å¼•ç”¨æ±¡æŸ“</li><li>åˆ›å»ºä¸­æŠ¥é”™é—´ä»¶çš„é›†åˆmiddleware</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token keyword">extends</span> <span class="token class-name">EventEmitter</span> <span class="token punctuation">{</span>\n  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// åˆ›å»ºå…¨æ–°çš„context request responseå¯¹è±¡</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>context <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// ä¿å­˜ä¸­é—´ä»¶çš„æ•°ç»„</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_2-use" tabindex="-1"><a class="header-anchor" href="#_2-use" aria-hidden="true">#</a> (2ï¼‰use()</h2><ol><li>éªŒè¯å¹¶æ·»åŠ ä¸­é—´ä»¶</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">!==</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&#39;middleware must be a function!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token comment">// å°†æ³¨å†Œçš„ä¸­é—´ä»¶æ·»åŠ åˆ°æ•°ç»„ä¸­ç®¡ç†</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>\n <span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_3-listen" tabindex="-1"><a class="header-anchor" href="#_3-listen" aria-hidden="true">#</a> (3ï¼‰listen()</h2><p>é€šè¿‡httpåˆ›å»ºserver,é€šè¿‡this.callbackå®Œæˆå›è°ƒ</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_4-callback" tabindex="-1"><a class="header-anchor" href="#_4-callback" aria-hidden="true">#</a> (4ï¼‰callback()</h2><ol><li>é€šè¿‡è°ƒç”¨composeåŒ…è£…ä¸­é—´ä»¶,è¿”å›ä¸€ä¸ªå¯æ‰§è¡Œçš„å‡½æ•°,è°ƒç”¨è¯¥å‡½æ•°åˆ™å¼€å§‹æ‰§è¡Œä¸­é—´ä»¶</li><li>åˆ›å»ºè¯·æ±‚ç›¸å…³çš„å¤„ç†å‡½æ•°,å†…éƒ¨åˆ›å»ºå…¨å±€ä¸Šä¸‹æ–‡å¯¹è±¡ctx,å°†ctxå’Œä¸­é—´ä»¶çš„è°ƒç”¨å‡½æ•°äº¤ç»™this.handleRequestå‡½æ•°å¤„ç†</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// fnå‡½æ•°å†…éƒ¨å°†æ‰§è¡Œæ³¨å†Œçš„ä¸­é—´ä»¶</span>\n  <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token comment">// å¤„ç†requestè¯·æ±‚</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">handleRequest</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">// åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡ctx</span>\n    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> handleRequest<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_5-compose" tabindex="-1"><a class="header-anchor" href="#_5-compose" aria-hidden="true">#</a> (5ï¼‰compose()</h2><ol><li>é»˜è®¤ç›´æ¥æ‰§è¡Œç¬¬ä¸€ä¸ªä¸­é—´ä»¶</li><li>æ²¡æœ‰ä¸­é—´ä»¶æˆ–ä¸­é—´ä»¶æ‰§è¡Œå®Œæ¯•ç›´æ¥è¿”å›æˆåŠŸçš„ç»“æœ</li><li>è®°å½•ä¸Šä¸€ä¸ªä¸­é—´ä»¶çš„ç´¢å¼•index,é˜²æ­¢ä¸€ä¸ªä¸­é—´ä»¶å†…å¤šæ¬¡è°ƒç”¨next()</li><li>é€’å½’è°ƒç”¨dispatch(),ä¸­é—´ä»¶çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ctxå¯¹è±¡,ç¬¬äºŒä¸ªå‚æ•°nextä¸º dispatch(i+1)</li></ol><p><img src="https://s2.loli.net/2022/08/05/ZlzrVMJmIiLCfkx.png" alt="image.png"></p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">compose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// æ¯ä¸ªä¸­é—´ä»·å¿…é¡»æ˜¯ä¸ªæ–¹æ³•</span>\n  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> fn <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fn <span class="token operator">!==</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span>\n      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&#39;Middleware must be composed of functions!&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span>\n  <span class="token comment">// å¼€å§‹æ‰§è¡Œä¸­é—´ä»¶</span>\n  <span class="token keyword">return</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    <span class="token comment">// ä¸Šä¸€ä¸ªä¸­é—´ä»¶çš„ç´¢å¼•</span>\n    <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>\n    <span class="token keyword">const</span> <span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token parameter">i</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token comment">// é˜²æ­¢ä¸­é—´å†…å¤šæ¬¡è°ƒç”¨nextå‡½æ•°</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> index<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&#39;next() called multiple times&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      index <span class="token operator">=</span> i<span class="token punctuation">;</span>\n      <span class="token comment">// æ²¡æœ‰ä¸­é—´ä»¶ æˆ–æ‰§è¡Œå®Œæœ€åä¸€ä¸ªä¸­é—´ä»¶ ç›´æ¥è¿”å›æˆåŠŸ</span>\n      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">.</span>length <span class="token operator">===</span> i<span class="token punctuation">)</span> <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token keyword">let</span> fn <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>\n      <span class="token keyword">try</span> <span class="token punctuation">{</span>\n        <span class="token comment">// next å‡½æ•°å†…éƒ¨è°ƒç”¨äº†dispatch,å¹¶ä¸”ç›´æ¥æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶</span>\n        <span class="token keyword">let</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n      <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span><span class="token punctuation">;</span>\n    <span class="token comment">// é»˜è®¤ç›´æ¥æ‰§è¡Œç¬¬ä¸€ä¸ªä¸­é—´ä»¶</span>\n    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token punctuation">}</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h2 id="_6-createcontext" tabindex="-1"><a class="header-anchor" href="#_6-createcontext" aria-hidden="true">#</a> (6ï¼‰createContext()</h2><p>æ¯ä¸€ä¸ªè¯·æ±‚éƒ½éœ€è¦æœ‰ä¸€ä¸ªå…¨æ–°çš„ä¸Šä¸‹æ–‡å¯¹è±¡,é€šè¿‡Object.createåˆ›å»º</p><p>å°†request,responseå¯¹è±¡æŒ‚è½½åˆ°ä¸Šä¸‹å¯¹è±¡ctxèº«ä¸Š,æ–¹ä¾¿é€šè¿‡__defineGetter__å’Œ__defineSetter__è¿›è¡Œå±æ€§å§”æ‰˜</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// åŸºäºåŸå‹é“¾åˆ›å»ºæ–°çš„ctx request response(é¿å…ä¸åŒçš„è¯·æ±‚æ±¡æŸ“)</span>\n  <span class="token keyword">const</span> ctx <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> request <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  <span class="token keyword">const</span> response <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>\n  ctx<span class="token punctuation">.</span>request <span class="token operator">=</span> request<span class="token punctuation">;</span> <span class="token comment">// ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ä¿å­˜åŒ…è£…åçš„requestå¯¹è±¡</span>\n  ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>req <span class="token operator">=</span> ctx<span class="token punctuation">.</span>req <span class="token operator">=</span> req<span class="token punctuation">;</span> <span class="token comment">// å°†åŸç”Ÿçš„requestå¯¹è±¡åˆ†åˆ«æŒ‚è½½åˆ° ctx.request å’Œ ctxä¸Š</span>\n  ctx<span class="token punctuation">.</span>response <span class="token operator">=</span> response<span class="token punctuation">;</span> <span class="token comment">// ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ä¿å­˜åŒ…è£…åçš„responseå¯¹è±¡</span>\n  ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>res <span class="token operator">=</span> ctx<span class="token punctuation">.</span>res <span class="token operator">=</span> res<span class="token punctuation">;</span> <span class="token comment">// å°†åŸç”Ÿçš„responseå¯¹è±¡åˆ†åˆ«æŒ‚è½½åˆ° ctx.response å’Œ ctxä¸Š</span>\n  <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="_7-handlerequest" tabindex="-1"><a class="header-anchor" href="#_7-handlerequest" aria-hidden="true">#</a> (7ï¼‰handleRequest()</h2><ol><li>åˆ›å»ºé»˜è®¤çš„çŠ¶æ€ç </li><li>æ‰§è¡Œå…¨éƒ¨ä¸­é—´ä»¶</li></ol><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// é»˜è®¤çš„çŠ¶æ€ç </span>\n  ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span><span class="token punctuation">;</span>\n  <span class="token comment">// ä¸åŒæƒ…å†µçš„å“åº”å¤„ç†</span>\n  <span class="token keyword">const</span> <span class="token function-variable function">handleResponse</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">respond</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>\n  <span class="token comment">// æ‰§è¡Œä¸­é—´ä»¶ å…¨éƒ¨ä¸­é—´ä»¶æˆåŠŸæ‰§è¡Œå®Œæ¯• æ‰§è¡Œrespondå“åº”ç»“æœ</span>\n  <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>handleResponse<span class="token punctuation">)</span>\n    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&#39;error&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="_8-respond" tabindex="-1"><a class="header-anchor" href="#_8-respond" aria-hidden="true">#</a> (8ï¼‰respond()</h2><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token function">respond</span><span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token comment">// [1] è¿™é‡Œä¸Šä¸‹æ–‡å¯¹è±¡çš„bodyå…¶å®æ˜¯ä»£ç†çš„responseå¯¹è±¡ä¸­çš„body</span>\n  <span class="token comment">// [2] ctx.body ==== ctx.response.body</span>\n  <span class="token comment">// [3] Koaæºç ä¸­ä½¿ç”¨delegateå‡½æ•°å®Œæˆä»£ç† (__defineGetter__ , __defineSetter__)</span>\n  <span class="token keyword">const</span> body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>body <span class="token operator">||</span> <span class="token string">&#39;Not Define&#39;</span><span class="token punctuation">;</span>\n  <span class="token keyword">return</span> ctx<span class="token punctuation">.</span>res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div>',33),y={render:function(n,s){const a=(0,p.up)("OutboundLink");return(0,p.wg)(),(0,p.iD)(p.HY,null,[(0,p._)("ul",null,[(0,p._)("li",null,[t,(0,p._)("a",e,[o,(0,p.Wm)(a)])]),(0,p._)("li",null,[(0,p._)("a",c,[l,(0,p.Wm)(a)])]),(0,p._)("li",null,[(0,p._)("a",u,[r,(0,p.Wm)(a)])])]),i,(0,p._)("p",null,[(0,p._)("a",k,[b,(0,p.Wm)(a)]),d]),(0,p._)("p",null,[(0,p._)("a",m,[h,(0,p.Wm)(a)]),g]),f],64)}}}}]);