"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[6124],{4188:(n,s,a)=>{a.r(s),a.d(s,{data:()=>p});const p={key:"v-0e364fbb",path:"/articles/Node/koa%E7%B3%BB%E5%88%97%EF%BC%881%EF%BC%89-%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%BC%80%E5%8F%91%E5%92%8C%E4%BD%BF%E7%94%A8.html",title:"koa中间件开发和使用",lang:"en-US",frontmatter:{},excerpt:"",headers:[{level:2,title:"generator中间件开发",slug:"generator中间件开发",children:[{level:3,title:"generator中间件开发",slug:"generator中间件开发-1",children:[]},{level:3,title:"generator中间件在koa@1中的使用",slug:"generator中间件在koa-1中的使用",children:[]},{level:3,title:"generator中间件在koa@2中的使用",slug:"generator中间件在koa-2中的使用",children:[]}]},{level:2,title:"async中间件开发",slug:"async中间件开发",children:[{level:3,title:"async 中间件开发",slug:"async-中间件开发",children:[]},{level:3,title:"async 中间件在koa@2中使用",slug:"async-中间件在koa-2中使用",children:[]}]}],filePathRelative:"articles/Node/koa系列（1）-中间件开发和使用.md",git:{}}},4178:(n,s,a)=>{a.r(s),a.d(s,{default:()=>t});const p=(0,a(6252).uE)('<h1 id="koa中间件开发和使用" tabindex="-1"><a class="header-anchor" href="#koa中间件开发和使用" aria-hidden="true">#</a> koa中间件开发和使用</h1><ul><li>koa v1和v2中使用到的中间件的开发和使用</li><li>generator 中间件开发在koa v1和v2中使用</li><li>async await 中间件开发和只能在koa v2中使用</li></ul><h2 id="generator中间件开发" tabindex="-1"><a class="header-anchor" href="#generator中间件开发" aria-hidden="true">#</a> generator中间件开发</h2><h3 id="generator中间件开发-1" tabindex="-1"><a class="header-anchor" href="#generator中间件开发-1" aria-hidden="true">#</a> generator中间件开发</h3><blockquote><p>generator中间件返回的应该是function * () 函数</p></blockquote><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* ./middleware/logger-generator.js */</span>\n<span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span> <span class="token parameter">ctx</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> ctx<span class="token punctuation">.</span>method<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>header<span class="token punctuation">.</span>host <span class="token operator">+</span> ctx<span class="token punctuation">.</span>url <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token operator">*</span> <span class="token punctuation">(</span> next <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n        <span class="token comment">// 执行中间件的操作</span>\n        <span class="token function">log</span><span class="token punctuation">(</span> <span class="token keyword">this</span> <span class="token punctuation">)</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span> next <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token keyword">yield</span> next\n        <span class="token punctuation">}</span>\n    <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="generator中间件在koa-1中的使用" tabindex="-1"><a class="header-anchor" href="#generator中间件在koa-1中的使用" aria-hidden="true">#</a> generator中间件在koa@1中的使用</h3><blockquote><p>generator 中间件在koa v1中可以直接use使用</p></blockquote><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span>  <span class="token comment">// koa v1</span>\n<span class="token keyword">const</span> loggerGenerator  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./middleware/logger-generator&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">loggerGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token operator">*</span><span class="token punctuation">(</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;hello world!&#39;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\napp<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;the server is starting at port 3000&#39;</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="generator中间件在koa-2中的使用" tabindex="-1"><a class="header-anchor" href="#generator中间件在koa-2中的使用" aria-hidden="true">#</a> generator中间件在koa@2中的使用</h3><blockquote><p>generator 中间件在koa v2中需要用koa-convert封装一下才能使用</p></blockquote><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span> <span class="token comment">// koa v2</span>\n<span class="token keyword">const</span> convert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-convert&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> loggerGenerator  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./middleware/logger-generator&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token function">loggerGenerator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token parameter">ctx</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;hello world!&#39;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\napp<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;the server is starting at port 3000&#39;</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="async中间件开发" tabindex="-1"><a class="header-anchor" href="#async中间件开发" aria-hidden="true">#</a> async中间件开发</h2><h3 id="async-中间件开发" tabindex="-1"><a class="header-anchor" href="#async-中间件开发" aria-hidden="true">#</a> async 中间件开发</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* ./middleware/logger-async.js */</span>\n\n<span class="token keyword">function</span> <span class="token function">log</span><span class="token punctuation">(</span> <span class="token parameter">ctx</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span> ctx<span class="token punctuation">.</span>method<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>header<span class="token punctuation">.</span>host <span class="token operator">+</span> ctx<span class="token punctuation">.</span>url <span class="token punctuation">)</span>\n<span class="token punctuation">}</span>\n\nmodule<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span> <span class="token parameter">ctx<span class="token punctuation">,</span> next</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>\n    <span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>\n    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n  <span class="token punctuation">}</span>\n<span class="token punctuation">}</span>\n\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="async-中间件在koa-2中使用" tabindex="-1"><a class="header-anchor" href="#async-中间件在koa-2中使用" aria-hidden="true">#</a> async 中间件在koa@2中使用</h3><blockquote><p>async 中间件只能在 koa v2中使用</p></blockquote><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span> <span class="token comment">// koa v2</span>\n<span class="token keyword">const</span> loggerAsync  <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./middleware/logger-async&#39;</span><span class="token punctuation">)</span>\n<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>\n\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">loggerAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>\n\napp<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token parameter">ctx</span> <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>\n    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&#39;hello world!&#39;</span>\n<span class="token punctuation">}</span><span class="token punctuation">)</span>\n\napp<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>\nconsole<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;the server is starting at port 3000&#39;</span><span class="token punctuation">)</span>\n</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div>',18),t={render:function(n,s){return p}}}}]);